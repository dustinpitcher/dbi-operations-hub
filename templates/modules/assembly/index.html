{% extends "base.html" %}

{% block title %}Assembly Management - DBI Operations Hub{% endblock %}

{% block extra_css %}
<style>
    .upload-section {
        background: #ecf0f1;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .reports-section {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    
    .report-panel {
        flex: 1;
        background: #fff;
        border: 1px solid #bdc3c7;
        border-radius: 8px;
    }
    
    .report-header {
        background: #34495e;
        color: white;
        padding: 15px;
        margin: 0;
        border-radius: 8px 8px 0 0;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    
    th, td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
    }
    
    th {
        background-color: #34495e;
        color: white;
        font-weight: bold;
    }
    
    .ready-for-production {
        background-color: #d5f4e6;
    }
    
    .cannot-assemble {
        background-color: #ffeaa7;
    }
    
    .transfer-needed {
        background-color: #81ecec;
    }
    
    .loading-container {
        display: none;
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    .progress-text {
        color: #2c3e50;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .progress-details {
        color: #7f8c8d;
        font-size: 14px;
        line-height: 1.5;
    }
    
    .status-ready {
        color: #27ae60;
        font-weight: bold;
    }
    
    .status-cannot {
        color: #e74c3c;
        font-weight: bold;
    }
    
    .upload-form {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
    }
    
    input[type="file"] {
        padding: 8px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        flex-grow: 1;
    }
    
    .instructions-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">üè≠ Assembly Management</h1>
        <p class="text-muted">Generate intelligent assembly recommendations and transfer suggestions</p>
    </div>

    <!-- Instructions Section -->
    <div class="instructions-section">
        <h3 style="margin: 0 0 10px 0; color: #856404;">üìã Data File Requirements:</h3>
        <button onclick="toggleInstructions()" class="btn btn-primary" style="font-size: 12px; padding: 5px 10px; margin-bottom: 15px;">Show/Hide Instructions</button>
        
        <div id="instructions" style="display: none;">
            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <strong>üîπ Availability Report (CSV)</strong><br>
                <em>Source:</em> <a href="https://inventory.dearsystems.com/Stock" target="_blank">Cin7Core ‚Üí Inventory ‚Üí Availability</a><br>
                <em>Required columns:</em> SKU, Location, Available, OnHand<br>
                <em>Export:</em> Select all products and export as CSV
            </div>
            
            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <strong>üîπ Replenishment Sales Data (CSV)</strong><br>
                <em>Source:</em> <a href="https://app.inventory-planner.com/#/replenishment" target="_blank">Inventory Planner ‚Üí Replenishment ‚Üí Combined NC Warehouse</a><br>
                <em>Required columns:</em> SKU, AVG sales/mo<br>
                <em>Optional columns:</em> Stock, Days of stock, Replenishment (for enhanced analysis)<br>
                <em>Export:</em> Use CSV export from the replenishment view
            </div>
            
            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <strong>üîπ BOM Component Availability (Excel)</strong><br>
                <em>Source:</em> <a href="https://inventory.dearsystems.com/Report/InventoryBOMComponentDetails" target="_blank">Cin7Core ‚Üí Reports ‚Üí BOM Component Availability</a><br>
                <em>Layout:</em> Select "Assembly Process" layout<br>
                <em>Required columns:</em> Product SKU, Component SKU, Quantity, Available<br>
                <em>Export:</em> Export as Excel (.xlsx) format
            </div>
            
            <div style="background: #e7f3ff; padding: 10px; border-radius: 4px; font-size: 14px;">
                <strong>üí° Pro Tips:</strong><br>
                ‚Ä¢ Column order doesn't matter - we match by header names<br>
                ‚Ä¢ Extra columns are fine - we'll ignore what we don't need<br>
                ‚Ä¢ SV-prefixed components (services) are automatically excluded<br>
                ‚Ä¢ Reports work best with current data (last 7 days)
            </div>
        </div>
    </div>

    <!-- File Upload Section -->
    <div class="upload-section">
        <h3>üìÅ Upload Data Files</h3>
        
        <form id="uploadForm" class="upload-form">
            <input type="file" id="availabilityFile" accept=".csv" required>
            <label>üìä Availability Report (CSV)</label>
        </form>
        <form class="upload-form">
            <input type="file" id="replenishmentFile" accept=".csv" required>
            <label>üìà Replenishment Sales Data (CSV)</label>
        </form>
        <form class="upload-form">
            <input type="file" id="bomFile" accept=".xlsx" required>
            <label>üîß BOM Component Availability (Excel)</label>
        </form>
        
        <button id="generateBtn" onclick="processData()" class="btn btn-success btn-large">üöÄ Generate Assembly Reports</button>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingSection" class="loading-container">
        <div class="spinner"></div>
        <div class="progress-text">üîÑ Processing Your Data...</div>
        <div class="progress-details">
            Analyzing inventory, sales velocity, and BOM components<br>
            This may take up to 5 minutes for large datasets<br>
            <small>Please don't refresh the page</small>
        </div>
    </div>

    <!-- Download Section -->
    <div id="downloadSection" style="display:none; background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h3>üìÅ Download Excel Report</h3>
        <p>Your comprehensive assembly and transfer analysis has been generated!</p>
        <a id="downloadLink" href="#" class="btn btn-success btn-large" style="text-decoration: none;">üìä Download Excel Report</a>
        <p style="margin-top: 10px; color: #666; font-size: 14px;">
            Excel file contains 4 sheets: Assembly Ready, Cannot Assemble, Transfer Recommendations, and Summary Dashboard
        </p>
    </div>

    <!-- Results Section -->
    <div id="results" style="display:none;">
        <div class="reports-section">
            <div class="report-panel">
                <h3 class="report-header">‚úÖ Products Ready for Assembly</h3>
                <div style="padding: 15px; max-height: 600px; overflow-y: auto;">
                    <table id="assemblyTable">
                        <thead>
                            <tr>
                                <th>Product SKU</th>
                                <th>Product Name</th>
                                <th>Assembly Status</th>
                                <th>Qty for Assembly</th>
                                <th>Available in NC</th>
                                <th>Avg Monthly Sales</th>
                                <th>Days of Inventory</th>
                            </tr>
                        </thead>
                        <tbody id="assemblyTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="report-panel">
                <h3 class="report-header">‚ùå Cannot Assemble</h3>
                <div style="padding: 15px; max-height: 300px; overflow-y: auto;">
                    <table id="cannotAssembleTable">
                        <thead>
                            <tr>
                                <th>Product SKU</th>
                                <th>Product Name</th>
                                <th>Missing Components</th>
                                <th>Required</th>
                                <th>Available</th>
                            </tr>
                        </thead>
                        <tbody id="cannotAssembleTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="report-panel" style="margin-top: 20px;">
            <h3 class="report-header">üì¶ Items to Transfer: NC-Armory ‚Üí NC-Main</h3>
            <div style="padding: 15px; max-height: 400px; overflow-y: auto;">
                <table id="transferTable">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Product Name</th>
                            <th>Qty in Armory</th>
                            <th>Qty in Main</th>
                            <th>Avg Monthly Sales</th>
                            <th>Days Supply in Main</th>
                            <th>Suggested Transfer</th>
                        </tr>
                    </thead>
                    <tbody id="transferTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleInstructions() {
    const instructions = document.getElementById('instructions');
    if (instructions.style.display === 'none') {
        instructions.style.display = 'block';
    } else {
        instructions.style.display = 'none';
    }
}

async function processData() {
    const files = {
        availability: document.getElementById('availabilityFile').files[0],
        replenishment: document.getElementById('replenishmentFile').files[0],
        bom: document.getElementById('bomFile').files[0]
    };
    
    if (!files.availability || !files.replenishment || !files.bom) {
        alert('Please select all three data files');
        return;
    }
    
    // Show loading indicator and disable button
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('generateBtn').disabled = true;
    document.getElementById('generateBtn').textContent = '‚è≥ Processing...';
    document.getElementById('downloadSection').style.display = 'none';
    document.getElementById('results').style.display = 'none';
    
    const formData = new FormData();
    formData.append('availability', files.availability);
    formData.append('replenishment', files.replenishment);
    formData.append('bom', files.bom);
    
    try {
        const response = await fetch('{{ url_for("assembly.process_assembly_files") }}', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Hide loading indicator
        document.getElementById('loadingSection').style.display = 'none';
        
        displayResults(data);
        
        // Show download section if Excel file was generated
        if (data.excel_file) {
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = '{{ url_for("assembly.download_assembly_file", filename="") }}' + encodeURIComponent(data.excel_file);
            document.getElementById('downloadSection').style.display = 'block';
        }
        
        document.getElementById('results').style.display = 'block';
        
    } catch (error) {
        // Hide loading indicator and show error
        document.getElementById('loadingSection').style.display = 'none';
        alert('Error processing files: ' + error.message);
    } finally {
        // Re-enable button
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').textContent = 'üöÄ Generate Assembly Reports';
    }
}

function displayResults(data) {
    // Assembly ready products
    const assemblyBody = document.getElementById('assemblyTableBody');
    assemblyBody.innerHTML = '';
    data.assembly_ready.forEach(item => {
        const row = assemblyBody.insertRow();
        row.className = 'ready-for-production';
        row.innerHTML = `
            <td>${item.product_sku}</td>
            <td>${item.product_name || 'Unknown'}</td>
            <td><span class="status-ready">Ready for production</span></td>
            <td>${item.quantity_for_assembly}</td>
            <td>${item.available_in_nc}</td>
            <td>${item.avg_monthly_sales}</td>
            <td>${item.days_of_inventory}</td>
        `;
    });
    
    // Cannot assemble
    const cannotBody = document.getElementById('cannotAssembleTableBody');
    cannotBody.innerHTML = '';
    data.cannot_assemble.forEach(item => {
        const row = cannotBody.insertRow();
        row.className = 'cannot-assemble';
        row.innerHTML = `
            <td>${item.product_sku}</td>
            <td>${item.product_name || 'Unknown'}</td>
            <td>${item.missing_components.join(', ')}</td>
            <td>${item.required_quantity || 'N/A'}</td>
            <td>${item.available_quantity || 'N/A'}</td>
        `;
    });
    
    // Transfer recommendations
    const transferBody = document.getElementById('transferTableBody');
    transferBody.innerHTML = '';
    data.transfer_recommendations.forEach(item => {
        const row = transferBody.insertRow();
        row.className = 'transfer-needed';
        row.innerHTML = `
            <td>${item.sku}</td>
            <td>${item.product_name}</td>
            <td>${item.qty_in_armory}</td>
            <td>${item.qty_in_main}</td>
            <td>${item.avg_monthly_sales}</td>
            <td>${item.days_supply_in_main}</td>
            <td><strong>${item.suggested_transfer}</strong></td>
        `;
    });
}
</script>
{% endblock %}
