name: ğŸ³ Deploy DBI Operations Hub via Docker to Azure

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  AZURE_WEBAPP_NAME: dbi-operations-hub
  AZURE_RESOURCE_GROUP: dbi-operations-hub-rg

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Validate Docker setup
      run: |
        echo "ğŸ” Validating Dockerfile and dependencies..."
        
        # Check required files
        for file in Dockerfile requirements.txt wsgi.py app.py config.py; do
          if [ ! -f "$file" ]; then
            echo "âŒ Required file missing: $file"
            exit 1
          fi
          echo "âœ… Found: $file"
        done
        
        # Check utils directory
        if [ ! -d "utils" ]; then
          echo "âŒ Utils directory missing"
          exit 1
        fi
        echo "âœ… Utils directory present"
        
        # Validate Dockerfile syntax
        docker --version
        echo "âœ… Docker validation completed"
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ”‘ Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ·ï¸ Extract Docker metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix=sha-
          type=raw,value=latest,enable={{is_default_branch}}
        labels: |
          org.opencontainers.image.title=DBI Operations Hub
          org.opencontainers.image.description=Comprehensive business operations platform
          org.opencontainers.image.vendor=Dirty Bird Industries
    
    - name: ğŸ”¨ Build and test Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: true
    
    - name: ğŸ§ª Test Docker container
      run: |
        echo "ğŸ§ª Testing Docker container functionality..."
        
        # Get the built image tag
        IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
        echo "Testing image: $IMAGE_TAG"
        
        # Run container in background for testing
        docker run -d \
          --name test-container \
          --env FLASK_ENV=production \
          --env SECRET_KEY=test-key-for-container-validation-only \
          --env LOG_LEVEL=INFO \
          --env PORT=8000 \
          --publish 8080:8000 \
          --health-start-period=30s \
          "$IMAGE_TAG"
        
        echo "â³ Waiting for container to start..."
        sleep 30
        
        # Check container status
        echo "ğŸ“‹ Container status:"
        docker ps | grep test-container || echo "Container not running"
        
        echo "ğŸ“‹ Container logs (last 20 lines):"
        docker logs --tail 20 test-container
        
        # Test health endpoint with better debugging
        echo "ğŸ¥ Testing health endpoint..."
        MAX_ATTEMPTS=6
        for i in $(seq 1 $MAX_ATTEMPTS); do
          echo "ğŸ” Health check attempt $i/$MAX_ATTEMPTS..."
          
          # Test with curl and show response
          RESPONSE=$(curl -s -m 15 http://localhost:8080/health 2>&1)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -m 15 http://localhost:8080/health 2>/dev/null)
          
          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $RESPONSE"
          
          if [[ "$RESPONSE" == *'"status": "healthy"'* ]]; then
            echo "âœ… Container health check passed!"
            break
          else
            if [ $i -eq $MAX_ATTEMPTS ]; then
              echo "âŒ Container health check failed after $MAX_ATTEMPTS attempts"
              echo "ğŸ“‹ Final container logs:"
              docker logs test-container
              exit 1
            else
              echo "â³ Retrying in 10 seconds..."
              sleep 10
            fi
          fi
        done
        
        # Test dashboard endpoint
        echo "ğŸ§ª Testing dashboard endpoint..."
        if curl -f -s -m 10 http://localhost:8080/ > /dev/null 2>&1; then
          echo "âœ… Dashboard endpoint: Responding"
        else
          echo "âš ï¸ Dashboard endpoint: Not responding (may be normal for test)"
        fi
        
        # Cleanup test container
        docker stop test-container || true
        docker rm test-container || true
        
        echo "âœ… Container testing completed successfully"
    
    - name: ğŸš€ Push Docker image to registry
      if: github.event_name != 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    environment:
      name: 'production'
      url: https://dbi-operations-hub.azurewebsites.net

    steps:
    - name: ğŸ”‘ Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ğŸ³ Deploy container to Azure App Service
      run: |
        echo "ğŸš€ Deploying Docker container to Azure App Service..."
        
        # Configure App Service for container deployment
        az webapp config container set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --docker-custom-image-name ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          --docker-registry-server-url https://${{ env.REGISTRY }} \
          --docker-registry-server-user ${{ github.actor }} \
          --docker-registry-server-password ${{ secrets.GITHUB_TOKEN }}
        
        # Configure production environment variables
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings \
            FLASK_ENV=production \
            LOG_LEVEL=INFO \
            WEBSITES_PORT=8000 \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE=true \
            DOCKER_REGISTRY_SERVER_URL=https://${{ env.REGISTRY }} \
            DOCKER_REGISTRY_SERVER_USERNAME=${{ github.actor }}
        
        echo "âœ… Container configuration completed"
    
    - name: ğŸ”„ Restart Azure App Service
      run: |
        echo "ğŸ”„ Restarting App Service to deploy new container..."
        az webapp restart \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
        echo "âœ… App Service restart initiated"
    
    - name: ğŸ¥ Comprehensive health verification
      run: |
        echo "â³ Waiting for deployment to stabilize..."
        sleep 90
        
        echo "ğŸ¥ Running comprehensive health verification..."
        BASE_URL="https://dbi-operations-hub.azurewebsites.net"
        HEALTH_URL="$BASE_URL/health"
        
        # Extended health check with multiple attempts
        for attempt in {1..12}; do
          echo "ğŸ” Health check attempt $attempt/12..."
          
          if HEALTH_RESPONSE=$(curl -f -s -m 30 "$HEALTH_URL" 2>/dev/null); then
            echo "ğŸ“Š Health response received"
            
            if echo "$HEALTH_RESPONSE" | grep -q '"status": "healthy"'; then
              echo "âœ… Health check PASSED!"
              echo "ğŸ“‹ Health data: $HEALTH_RESPONSE"
              
              # Test critical endpoints
              echo "ğŸ§ª Testing critical application endpoints..."
              
              # Dashboard
              if curl -f -s -m 15 "$BASE_URL/" > /dev/null 2>&1; then
                echo "âœ… Dashboard: Responding"
              else
                echo "âš ï¸ Dashboard: Not responding"
              fi
              
              # Assembly module
              if curl -f -s -m 15 "$BASE_URL/assembly/" > /dev/null 2>&1; then
                echo "âœ… Assembly Module: Responding"
              else
                echo "âš ï¸ Assembly Module: Not responding"
              fi
              
              # Purchase Orders module
              if curl -f -s -m 15 "$BASE_URL/po/" > /dev/null 2>&1; then
                echo "âœ… Purchase Orders Module: Responding"
              else
                echo "âš ï¸ Purchase Orders Module: Not responding"
              fi
              
              echo "ğŸ‰ Deployment health verification COMPLETED!"
              break
            else
              echo "âš ï¸ Health endpoint responding but status is not healthy"
              echo "ğŸ“‹ Response: $HEALTH_RESPONSE"
            fi
          else
            echo "âš ï¸ Health endpoint not responding"
          fi
          
          if [ $attempt -eq 12 ]; then
            echo "âŒ Health verification FAILED after 12 attempts"
            echo "ğŸ“‹ Attempting to fetch application logs..."
            
            # Try to get some diagnostic information
            az webapp log download \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --log-file deployment-logs.zip || echo "Could not fetch logs"
            
            exit 1
          else
            echo "â³ Retrying in 15 seconds..."
            sleep 15
          fi
        done
    
    - name: ğŸŠ Deployment Success Summary
      run: |
        echo "ğŸ‰ ğŸ‰ DBI OPERATIONS HUB DEPLOYMENT SUCCESSFUL! ğŸ‰ ğŸ‰"
        echo ""
        echo "ğŸ³ Container Details:"
        echo "  ğŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "  ğŸ”§ Runtime: Python 3.9 with Gunicorn"
        echo "  ğŸ›¡ï¸ Security: Enhanced with comprehensive validation"
        echo ""
        echo "ğŸŒ Application Access:"
        echo "  ğŸ  Main Dashboard: https://dbi-operations-hub.azurewebsites.net"
        echo "  ğŸ­ Assembly Management: https://dbi-operations-hub.azurewebsites.net/assembly/"
        echo "  ğŸ’° Purchase Orders: https://dbi-operations-hub.azurewebsites.net/po/"
        echo "  ğŸš« Supplier Management: https://dbi-operations-hub.azurewebsites.net/po/manage-suppliers"
        echo ""
        echo "ğŸ”§ Administrative Endpoints:"
        echo "  ğŸ“Š Health Check: https://dbi-operations-hub.azurewebsites.net/health"
        echo "  ğŸ§¹ Manual Cleanup: https://dbi-operations-hub.azurewebsites.net/system/cleanup"
        echo ""
        echo "âœ¨ Enhanced Features Active:"
        echo "  ğŸ” File upload security validation"
        echo "  ğŸ“Š Structured logging and monitoring"  
        echo "  ğŸš¨ Error alerting system"
        echo "  ğŸ§¹ Automated file cleanup service"
        echo "  ğŸ›¡ï¸ Environment validation and safeguards"